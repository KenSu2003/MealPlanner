<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="fas fa-calendar-alt"></i> Monthly Meal Plan - {{ month_name }} {{ year }}</h3>
    <div>
        <button class="btn btn-outline-primary me-2" onclick="previousMonth()">
            <i class="fas fa-chevron-left"></i> Previous
        </button>
        <button class="btn btn-primary" onclick="autoGeneratePlan()">
            <i class="fas fa-magic"></i> Auto Generate
        </button>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <!-- Calendar Header -->
        <div class="row text-center mb-3">
            <div class="col">Sun</div>
            <div class="col">Mon</div>
            <div class="col">Tue</div>
            <div class="col">Wed</div>
            <div class="col">Thu</div>
            <div class="col">Fri</div>
            <div class="col">Sat</div>
        </div>

        <!-- Calendar Grid -->
        {% for week in calendar %}
        <div class="row mb-2">
            {% for day in week %}
            <div class="col calendar-day" style="min-height: 120px; border: 1px solid #dee2e6; padding: 8px;">
                {% if day != 0 %}
                <div class="d-flex justify-content-between align-items-start">
                    <span class="fw-bold">{{ day }}</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="openMealPlanModal('{{ year }}-{{ '%02d'|format(month) }}-{{ '%02d'|format(day) }}')">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <!-- Meal Plan Display -->
                {% set date_str = year|string + '-' + '%02d'|format(month) + '-' + '%02d'|format(day) %}
                {% if date_str in meal_plan %}
                <div class="mt-2">
                    {% if 'breakfast' in meal_plan[date_str] %}
                    <div class="small mb-1">
                        <span class="badge bg-warning text-dark">B</span>
                        <small>{{ meal_plan[date_str]['breakfast'][:15] }}{% if meal_plan[date_str]['breakfast']|length > 15 %}...{% endif %}</small>
                    </div>
                    {% endif %}
                    
                    {% if 'lunch' in meal_plan[date_str] %}
                    <div class="small mb-1">
                        <span class="badge bg-info">L</span>
                        <small>{{ meal_plan[date_str]['lunch'][:15] }}{% if meal_plan[date_str]['lunch']|length > 15 %}...{% endif %}</small>
                    </div>
                    {% endif %}
                    
                    {% if 'dinner' in meal_plan[date_str] %}
                    <div class="small mb-1">
                        <span class="badge bg-success">D</span>
                        <small>{{ meal_plan[date_str]['dinner'][:15] }}{% if meal_plan[date_str]['dinner']|length > 15 %}...{% endif %}</small>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% else %}
                <span class="text-muted">&nbsp;</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Meal Plan Legend -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle"></i> Legend</h6>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-warning text-dark me-2">B</span>
                    <span>Breakfast</span>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-info me-2">L</span>
                    <span>Lunch</span>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-success me-2">D</span>
                    <span>Dinner</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-bar"></i> This Month's Stats</h6>
            </div>
            <div class="card-body">
                {% set total_planned = 0 %}
                {% for date_str, meals in meal_plan.items() %}
                    {% set total_planned = total_planned + meals|length %}
                {% endfor %}
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Total Meals Planned:</span>
                    <span class="fw-bold">{{ total_planned }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Days with Plans:</span>
                    <span class="fw-bold">{{ meal_plan|length }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Available Meals:</span>
                    <span class="fw-bold">{{ meals|length }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Meal Plan Modal -->
<div class="modal fade" id="mealPlanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Plan Meals for <span id="planDate"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="mealPlanForm">
                    <input type="hidden" id="planDateInput">
                    
                    <div class="mb-3">
                        <label class="form-label">Breakfast</label>
                        <select class="form-select" id="breakfastMeal">
                            <option value="">No meal planned</option>
                            {% for meal in meals %}
                            <option value="{{ meal[0] }}">{{ meal[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Lunch</label>
                        <select class="form-select" id="lunchMeal">
                            <option value="">No meal planned</option>
                            {% for meal in meals %}
                            <option value="{{ meal[0] }}">{{ meal[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Dinner</label>
                        <select class="form-select" id="dinnerMeal">
                            <option value="">No meal planned</option>
                            {% for meal in meals %}
                            <option value="{{ meal[0] }}">{{ meal[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMealPlan()">Save Plan</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentYear = {{ year }};
let currentMonth = {{ month }};

function openMealPlanModal(date) {
    document.getElementById('planDate').textContent = date;
    document.getElementById('planDateInput').value = date;
    
    // Load existing meal plan for this date
    const dateStr = date;
    const existingPlan = {{ meal_plan|tojson }};
    
    if (existingPlan[dateStr]) {
        if (existingPlan[dateStr]['breakfast']) {
            // Find meal ID by name
            const breakfastMeal = {{ meals|tojson }}.find(m => m[1] === existingPlan[dateStr]['breakfast']);
            if (breakfastMeal) {
                document.getElementById('breakfastMeal').value = breakfastMeal[0];
            }
        }
        if (existingPlan[dateStr]['lunch']) {
            const lunchMeal = {{ meals|tojson }}.find(m => m[1] === existingPlan[dateStr]['lunch']);
            if (lunchMeal) {
                document.getElementById('lunchMeal').value = lunchMeal[0];
            }
        }
        if (existingPlan[dateStr]['dinner']) {
            const dinnerMeal = {{ meals|tojson }}.find(m => m[1] === existingPlan[dateStr]['dinner']);
            if (dinnerMeal) {
                document.getElementById('dinnerMeal').value = dinnerMeal[0];
            }
        }
    } else {
        // Clear form
        document.getElementById('breakfastMeal').value = '';
        document.getElementById('lunchMeal').value = '';
        document.getElementById('dinnerMeal').value = '';
    }
    
    const modal = new bootstrap.Modal(document.getElementById('mealPlanModal'));
    modal.show();
}

function saveMealPlan() {
    const date = document.getElementById('planDateInput').value;
    const breakfast = document.getElementById('breakfastMeal').value;
    const lunch = document.getElementById('lunchMeal').value;
    const dinner = document.getElementById('dinnerMeal').value;
    
    // Save each meal type
    const mealTypes = [
        { type: 'breakfast', mealId: breakfast },
        { type: 'lunch', mealId: lunch },
        { type: 'dinner', mealId: dinner }
    ];
    
    let savedCount = 0;
    mealTypes.forEach(meal => {
        if (meal.mealId) {
            fetch('/save_meal_plan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    date: date,
                    meal_id: meal.mealId,
                    meal_type: meal.type
                })
            })
            .then(response => response.json())
            .then(data => {
                savedCount++;
                if (savedCount === mealTypes.length) {
                    bootstrap.Modal.getInstance(document.getElementById('mealPlanModal')).hide();
                    loadCalendar();
                }
            });
        } else {
            savedCount++;
        }
    });
}

function previousMonth() {
    // This would navigate to the previous month
    // For now, we'll just reload the current month
    loadCalendar();
}

function autoGeneratePlan() {
    const data = {
        year: currentYear,
        month: currentMonth
    };

    fetch('/auto_generate_plan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadCalendar();
        } else {
            alert(data.message || 'Failed to generate plan');
        }
    });
}
</script> 